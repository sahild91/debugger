import * as vscode from 'vscode';
import { WebviewProvider } from './webview/webviewProvider';
import { SDKManager } from './managers/sdkManager';
import { ToolchainManager } from './managers/toolchainManager';
import { SerialManager } from './managers/serialManager';
import { BuildCommand } from './commands/buildCommand';
import { FlashCommand } from './commands/flashCommand';
import { DebugCommand } from './commands/debugCommand';

let outputChannel: vscode.OutputChannel;
let webviewProvider: WebviewProvider;
let sdkManager: SDKManager;
let toolchainManager: ToolchainManager;
let serialManager: SerialManager;
let statusBarItem: vscode.StatusBarItem;

export async function activate(context: vscode.ExtensionContext) {
    // Initialize output channel for logging
    outputChannel = vscode.window.createOutputChannel('Port11 Debugger');
    
    // Show output channel only in debug mode or if specified in settings
    const showLogsOnStartup = vscode.workspace.getConfiguration('port11-debugger').get('showLogsOnStartup', false);
    if (showLogsOnStartup) {
        outputChannel.show();
    }
    
    outputChannel.appendLine('Port11 Debugger extension activated');
    outputChannel.appendLine(`VS Code version: ${vscode.version}`);
    outputChannel.appendLine(`Extension path: ${context.extensionPath}`);

    // Initialize status bar item
    statusBarItem = vscode.window.createStatusBarItem(vscode.StatusBarAlignment.Left, 100);
    statusBarItem.command = 'port11-debugger.showPanel';
    updateStatusBar('Initializing...');

    // Initialize managers
    try {
        outputChannel.appendLine('Initializing managers...');
        sdkManager = new SDKManager(context, outputChannel);
        toolchainManager = new ToolchainManager(context, outputChannel);
        serialManager = new SerialManager(outputChannel);
        
        outputChannel.appendLine('Managers initialized successfully');
    } catch (error) {
        const errorMessage = error instanceof Error ? error.message : String(error);
        outputChannel.appendLine(`Failed to initialize managers: ${errorMessage}`);
        throw error;
    }
    
    // Initialize webview provider
    try {
        outputChannel.appendLine('Initializing webview provider...');
        webviewProvider = new WebviewProvider(context, outputChannel, {
            sdkManager,
            toolchainManager,
            serialManager
        });
        outputChannel.appendLine('Webview provider initialized successfully');
    } catch (error) {
        const errorMessage = error instanceof Error ? error.message : String(error);
        outputChannel.appendLine(`Failed to initialize webview provider: ${errorMessage}`);
        throw error;
    }

    // Initialize commands
    try {
        outputChannel.appendLine('Initializing command handlers...');
        const buildCommand = new BuildCommand(context, outputChannel, sdkManager, toolchainManager);
        const flashCommand = new FlashCommand(context, outputChannel, serialManager);
        const debugCommand = new DebugCommand(context, outputChannel, serialManager);
        outputChannel.appendLine('Command handlers initialized successfully');

        // Register all commands
        const commands = [
            // Setup and management commands
            vscode.commands.registerCommand('port11-debugger.setup', () => setupToolchain()),
            vscode.commands.registerCommand('port11-debugger.refreshStatus', () => refreshStatus()),
            vscode.commands.registerCommand('port11-debugger.showPanel', () => webviewProvider.show()),
            vscode.commands.registerCommand('port11-debugger.openSettings', () => openExtensionSettings()),
            vscode.commands.registerCommand('port11-debugger.showLogs', () => outputChannel.show()),

            // Build commands
            vscode.commands.registerCommand('port11-debugger.build', () => buildCommand.execute()),
            vscode.commands.registerCommand('port11-debugger.clean', () => buildCommand.execute({ clean: true })),

            // Flash commands
            vscode.commands.registerCommand('port11-debugger.flash', () => flashCommand.execute()),

            // Debug commands
            vscode.commands.registerCommand('port11-debugger.debug.start', (port?: string) => debugCommand.start(port)),
            vscode.commands.registerCommand('port11-debugger.debug.stop', () => debugCommand.stop()),
            vscode.commands.registerCommand('port11-debugger.debug.pause', () => debugCommand.halt()),
            vscode.commands.registerCommand('port11-debugger.debug.resume', () => debugCommand.resume()),
            vscode.commands.registerCommand('port11-debugger.debug.restart', () => restartDebugSession(debugCommand)),

            // Board management commands
            vscode.commands.registerCommand('port11-debugger.detectBoards', () => detectBoards()),
            vscode.commands.registerCommand('port11-debugger.openMainPanel', async () => {
                outputChannel.appendLine('Starting Creating standalone Port11 Debugger panel...');
                
                try {
                    // Create a webview panel
                    const panel = vscode.window.createWebviewPanel(
                        'port11MainPanel',
                        'Port11 Debugger - Main Panel',
                        vscode.ViewColumn.One,
                        {
                            enableScripts: true,
                            retainContextWhenHidden: true,
                            localResourceRoots: [
                                context.extensionUri,
                                vscode.Uri.joinPath(context.extensionUri, 'resources')
                            ]
                        }
                    );

                    // Set the HTML content
                    const scriptUri = panel.webview.asWebviewUri(
                        vscode.Uri.joinPath(context.extensionUri, 'resources', 'webview', 'main.js')
                    );
                    const styleUri = panel.webview.asWebviewUri(
                        vscode.Uri.joinPath(context.extensionUri, 'resources', 'webview', 'main.css')
                    );

                    // Try to load HTML template
                    let htmlContent: string;
                    try {
                        const htmlPath = vscode.Uri.joinPath(context.extensionUri, 'resources', 'webview', 'main.html');
                        const htmlBytes = await vscode.workspace.fs.readFile(htmlPath);
                        htmlContent = Buffer.from(htmlBytes).toString('utf8');
                        
                        // Replace template placeholders
                        htmlContent = htmlContent.replace(/\{\{styleUri\}\}/g, styleUri.toString());
                        htmlContent = htmlContent.replace(/\{\{scriptUri\}\}/g, scriptUri.toString());
                        
                        outputChannel.appendLine('Success: HTML template loaded from file');
                    } catch (error) {
                        outputChannel.appendLine(`Warning: Could not load HTML template: ${error}`);
                        
                        // Use fallback HTML with full interface
                        htmlContent = `
                        <!DOCTYPE html>
                        <html lang="en">
                        <head>
                            <meta charset="UTF-8">
                            <meta name="viewport" content="width=device-width, initial-scale=1.0">
                            <title>Port11 Debugger</title>
                            <link href="${styleUri}" rel="stylesheet">
                            <style>
                                body { 
                                    font-family: var(--vscode-font-family); 
                                    padding: 20px; 
                                    color: var(--vscode-foreground);
                                    background-color: var(--vscode-editor-background);
                                }
                                .section { 
                                    margin-bottom: 30px; 
                                    padding: 20px; 
                                    background: var(--vscode-input-background); 
                                    border: 1px solid var(--vscode-input-border); 
                                    border-radius: 8px; 
                                }
                                .action-btn {
                                    padding: 12px 24px;
                                    margin: 8px;
                                    background: var(--vscode-button-background);
                                    color: var(--vscode-button-foreground);
                                    border: none;
                                    border-radius: 6px;
                                    cursor: pointer;
                                    font-size: 14px;
                                }
                                .action-btn:hover:not(:disabled) {
                                    background: var(--vscode-button-hoverBackground);
                                }
                                .action-btn:disabled {
                                    opacity: 0.6;
                                    cursor: not-allowed;
                                }
                                .status-item {
                                    display: flex;
                                    align-items: center;
                                    padding: 15px;
                                    margin: 10px 0;
                                    background: var(--vscode-list-hoverBackground);
                                    border-radius: 6px;
                                }
                                .status-icon {
                                    font-size: 24px;
                                    margin-right: 15px;
                                }
                                .progress-container {
                                    margin: 20px 0;
                                    padding: 15px;
                                    background: var(--vscode-input-background);
                                    border-radius: 6px;
                                    display: none;
                                }
                                .progress-bar {
                                    width: 100%;
                                    height: 8px;
                                    background: var(--vscode-input-background);
                                    border-radius: 4px;
                                    overflow: hidden;
                                    margin: 10px 0;
                                }
                                .progress-fill {
                                    height: 100%;
                                    background: var(--vscode-progressBar-background);
                                    transition: width 0.3s ease;
                                    width: 0%;
                                }
                                #footer-status {
                                    position: fixed;
                                    bottom: 20px;
                                    right: 20px;
                                    padding: 10px 15px;
                                    background: var(--vscode-badge-background);
                                    color: var(--vscode-badge-foreground);
                                    border-radius: 15px;
                                    font-size: 12px;
                                }
                            </style>
                        </head>
                        <body>
                            <div class="container">
                                <header style="text-align: center; margin-bottom: 40px;">
                                    <h1 style="font-size: 28px; margin-bottom: 10px;">Starting Port11 Debugger</h1>
                                    <p style="color: var(--vscode-descriptionForeground); font-size: 16px;">MSPM0 Development Environment</p>
                                </header>

                                <div class="section">
                                    <h2>Status System Status</h2>
                                    <div id="status-grid">
                                        <div class="status-item" id="status-sdk">
                                            <div class="status-icon">Package</div>
                                            <div>
                                                <h3 style="margin: 0 0 5px 0;">MSPM0 SDK</h3>
                                                <p id="sdk-status-text" style="margin: 0; color: var(--vscode-descriptionForeground);">Checking...</p>
                                                <small id="sdk-version" style="color: var(--vscode-descriptionForeground);"></small>
                                            </div>
                                        </div>

                                        <div class="status-item" id="status-toolchain">
                                            <div class="status-icon">Setup</div>
                                            <div>
                                                <h3 style="margin: 0 0 5px 0;">ARM-CGT-CLANG</h3>
                                                <p id="toolchain-status-text" style="margin: 0; color: var(--vscode-descriptionForeground);">Checking...</p>
                                                <small id="toolchain-version" style="color: var(--vscode-descriptionForeground);"></small>
                                            </div>
                                        </div>

                                        <div class="status-item" id="status-board">
                                            <div class="status-icon">Connect</div>
                                            <div>
                                                <h3 style="margin: 0 0 5px 0;">Connected Boards</h3>
                                                <p id="board-status-text" style="margin: 0; color: var(--vscode-descriptionForeground);">Checking...</p>
                                                <small id="board-count" style="color: var(--vscode-descriptionForeground);"></small>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div id="setup-progress" class="progress-container">
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                            <h3 id="progress-title">Setting up...</h3>
                                            <span id="progress-percentage">0%</span>
                                        </div>
                                        <div class="progress-bar">
                                            <div id="progress-fill" class="progress-fill"></div>
                                        </div>
                                        <p id="progress-text" style="margin: 10px 0 0 0; color: var(--vscode-descriptionForeground);">Initializing...</p>
                                    </div>
                                </div>

                                <div class="section">
                                    <h2>Quick Quick Actions</h2>
                                    <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                                        <button id="setup-btn" class="action-btn">Setup Setup Toolchain</button>
                                        <button id="build-btn" class="action-btn" disabled>Build Build Project</button>
                                        <button id="flash-btn" class="action-btn" disabled>Quick Flash Firmware</button>
                                        <button id="debug-btn" class="action-btn" disabled>Debug Start Debug</button>
                                    </div>
                                </div>

                                <div class="section">
                                    <h2>Connect Board Management</h2>
                                    <button id="detect-boards-btn" class="action-btn">Detect Detect Boards</button>
                                    <div id="boards-list" style="margin-top: 15px;">
                                        <p style="text-align: center; color: var(--vscode-descriptionForeground); padding: 20px;">
                                            Click "Detect Boards" to scan for connected devices
                                        </p>
                                    </div>
                                </div>

                                <div id="debug-section" class="section" style="display: none;">
                                    <h2>Debug Debug Controls</h2>
                                    <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                                        <button id="debug-halt-btn" class="action-btn" disabled>⏸️ Halt</button>
                                        <button id="debug-resume-btn" class="action-btn" disabled>▶️ Resume</button>
                                        <button id="debug-stop-btn" class="action-btn" disabled>⏹️ Stop</button>
                                    </div>
                                    <div id="registers-list">
                                        <p style="text-align: center; color: var(--vscode-descriptionForeground); padding: 20px;">
                                            No debug session active
                                        </p>
                                    </div>
                                </div>
                            </div>

                            <div id="footer-status">Ready</div>

                            <script>
                                const vscode = acquireVsCodeApi();
                                console.log('Starting Port11 Debugger panel loaded');
                                
                                // Set up event listeners
                                document.getElementById('setup-btn').addEventListener('click', () => {
                                    console.log('Setup button clicked');
                                    vscode.postMessage({ command: 'startSetup' });
                                    showProgress('Starting setup...');
                                });
                                
                                document.getElementById('build-btn').addEventListener('click', () => {
                                    console.log('Build button clicked');
                                    vscode.postMessage({ command: 'buildProject' });
                                });
                                
                                document.getElementById('flash-btn').addEventListener('click', () => {
                                    console.log('Flash button clicked');
                                    vscode.postMessage({ command: 'flashFirmware' });
                                });
                                
                                document.getElementById('debug-btn').addEventListener('click', () => {
                                    console.log('Debug button clicked');
                                    vscode.postMessage({ command: 'startDebug' });
                                });
                                
                                document.getElementById('detect-boards-btn').addEventListener('click', () => {
                                    console.log('Detect boards clicked');
                                    vscode.postMessage({ command: 'detectBoards' });
                                    updateFooterStatus('Detecting boards...');
                                });
                                
                                // Helper functions
                                function showProgress(message) {
                                    const progressContainer = document.getElementById('setup-progress');
                                    const progressText = document.getElementById('progress-text');
                                    
                                    if (progressContainer && progressText) {
                                        progressContainer.style.display = 'block';
                                        progressText.textContent = message;
                                    }
                                }
                                
                                function updateFooterStatus(status) {
                                    const footer = document.getElementById('footer-status');
                                    if (footer) {
                                        footer.textContent = status;
                                    }
                                }
                                
                                // Request initial status
                                vscode.postMessage({ command: 'getStatus' });
                                updateFooterStatus('Panel loaded - Ready');
                                
                                // Listen for messages from extension
                                window.addEventListener('message', event => {
                                    const message = event.data;
                                    console.log('Message: Received message:', message);
                                    
                                    switch (message.command) {
                                        case 'updateStatus':
                                            console.log('Status updated:', message.data);
                                            break;
                                        case 'setupProgress':
                                            if (message.data) {
                                                updateSetupProgress(message.data.progress, message.data.message);
                                            }
                                            break;
                                        case 'setupComplete':
                                            hideProgress();
                                            updateFooterStatus('Setup complete!');
                                            break;
                                        case 'error':
                                            updateFooterStatus('Error: ' + message.data?.message);
                                            break;
                                    }
                                });
                                
                                function updateSetupProgress(percentage, message) {
                                    const progressFill = document.getElementById('progress-fill');
                                    const progressText = document.getElementById('progress-text');
                                    const progressPercentage = document.getElementById('progress-percentage');
                                    
                                    if (progressFill) progressFill.style.width = percentage + '%';
                                    if (progressText) progressText.textContent = message;
                                    if (progressPercentage) progressPercentage.textContent = percentage + '%';
                                    
                                    showProgress(message);
                                }
                                
                                function hideProgress() {
                                    const progressContainer = document.getElementById('setup-progress');
                                    if (progressContainer) {
                                        progressContainer.style.display = 'none';
                                    }
                                }
                            </script>
                            <script src="${scriptUri}"></script>
                        </body>
                        </html>`;
                    }

                    panel.webview.html = htmlContent;

                    // Handle messages from webview
                    panel.webview.onDidReceiveMessage(
                        async message => {
                            outputChannel.appendLine(`Message: Panel received message: ${message.command}`);
                            
                            try {
                                // Forward messages to the webview provider's message handler
                                // You'll need to make the handleMessage method public or create a forwarder
                                switch (message.command) {
                                    case 'startSetup':
                                        await webviewProvider.startSetup();
                                        break;
                                    case 'detectBoards':
                                        // Call serial manager directly
                                        const boards = await serialManager.detectBoards();
                                        panel.webview.postMessage({
                                            command: 'boardsDetected',
                                            data: { boards }
                                        });
                                        break;
                                    case 'getStatus':
                                        // Get status and send to panel
                                        const sdkInstalled = await sdkManager.isSDKInstalled();
                                        const toolchainInstalled = await toolchainManager.isToolchainInstalled();
                                        panel.webview.postMessage({
                                            command: 'updateStatus',
                                            data: { 
                                                status: { sdkInstalled, toolchainInstalled, boardConnected: false, setupComplete: sdkInstalled && toolchainInstalled }
                                            }
                                        });
                                        break;
                                    default:
                                        outputChannel.appendLine(`Unknown panel command: ${message.command}`);
                                }
                            } catch (error) {
                                outputChannel.appendLine(`Error handling panel message: ${error}`);
                                panel.webview.postMessage({
                                    command: 'error',
                                    data: { message: String(error) }
                                });
                            }
                        },
                        undefined,
                        context.subscriptions
                    );

                    outputChannel.appendLine('Success: Standalone panel created successfully!');
                    
                } catch (error) {
                    outputChannel.appendLine(`Error: Error creating standalone panel: ${error}`);
                    vscode.window.showErrorMessage(`Failed to create Port11 panel: ${error}`);
                }
            }),
        ];

        // Register webview provider
        const webviewDisposable = vscode.window.registerWebviewViewProvider(
            'port11-debugger.mainView',
            webviewProvider,
            { webviewOptions: { retainContextWhenHidden: true } }
        );

        // Add all disposables to context
        context.subscriptions.push(
            outputChannel,
            statusBarItem,
            webviewDisposable,
            ...commands
        );

        outputChannel.appendLine(`Successfully registered ${commands.length} commands`);
    } catch (error) {
        const errorMessage = error instanceof Error ? error.message : String(error);
        outputChannel.appendLine(`Failed to register commands: ${errorMessage}`);
        throw error;
    }

    // Initialize extension
    try {
        await initializeExtension();
    } catch (error) {
        const errorMessage = error instanceof Error ? error.message : String(error);
        outputChannel.appendLine(`Extension initialization failed: ${errorMessage}`);
        vscode.window.showErrorMessage(`Port11 Debugger initialization failed: ${errorMessage}`);
    }

    outputChannel.appendLine('Port11 Debugger extension activation completed');
}

export function deactivate() {
    outputChannel?.appendLine('Port11 Debugger extension deactivated');
    statusBarItem?.dispose();
    outputChannel?.dispose();
}

// Command implementations

async function setupToolchain(): Promise<void> {
    try {
        outputChannel.appendLine('Starting toolchain setup...');
        updateStatusBar('Setting up toolchain...');
        
        // Show webview panel
        webviewProvider.show();
        
        // Start setup process
        await webviewProvider.startSetup();
        
        outputChannel.appendLine('Toolchain setup completed successfully');
        updateStatusBar('Setup complete');
        
    } catch (error) {
        const errorMessage = error instanceof Error ? error.message : String(error);
        outputChannel.appendLine(`Setup failed: ${errorMessage}`);
        updateStatusBar('Setup failed');
        vscode.window.showErrorMessage(`Port11 Debugger setup failed: ${errorMessage}`);
    }
}

async function refreshStatus(): Promise<void> {
    try {
        outputChannel.appendLine('Refreshing status...');
        updateStatusBar('Refreshing...');
        
        // Check SDK status
        const sdkInstalled = await sdkManager.isSDKInstalled();
        const sdkVersion = await sdkManager.getSDKVersion();
        
        // Check toolchain status
        const toolchainInstalled = await toolchainManager.isToolchainInstalled();
        const toolchainInfo = await toolchainManager.getToolchainInfo();
        
        // Check board connections
        const boards = await serialManager.detectBoards();
        
        outputChannel.appendLine(`Status refresh complete:`);
        outputChannel.appendLine(`  SDK: ${sdkInstalled ? `installed (${sdkVersion})` : 'not installed'}`);
        outputChannel.appendLine(`  Toolchain: ${toolchainInstalled ? `installed (${toolchainInfo.version})` : 'not installed'}`);
        outputChannel.appendLine(`  Boards: ${boards.length} detected`);
        
        // Update status bar
        if (sdkInstalled && toolchainInstalled) {
            updateStatusBar(`Ready (${boards.length} boards)`);
        } else {
            updateStatusBar('Setup required');
        }
        
        // Refresh webview if visible
        if (webviewProvider) {
            // Trigger webview status update
            // Note: This would typically send a message to the webview to refresh its status
            outputChannel.appendLine('Webview status refreshed');
        }
        
    } catch (error) {
        const errorMessage = error instanceof Error ? error.message : String(error);
        outputChannel.appendLine(`Status refresh failed: ${errorMessage}`);
        updateStatusBar('Status error');
        vscode.window.showWarningMessage(`Status refresh failed: ${errorMessage}`);
    }
}

async function restartDebugSession(debugCommand: DebugCommand): Promise<void> {
    try {
        outputChannel.appendLine('Restarting debug session...');
        
        // Stop current session if active
        await debugCommand.stop();
        
        // Wait a moment before restarting
        await new Promise(resolve => setTimeout(resolve, 1000));
        
        // Start new session
        await debugCommand.start();
        
        outputChannel.appendLine('Debug session restarted successfully');
        
    } catch (error) {
        const errorMessage = error instanceof Error ? error.message : String(error);
        outputChannel.appendLine(`Debug session restart failed: ${errorMessage}`);
        vscode.window.showErrorMessage(`Debug restart failed: ${errorMessage}`);
    }
}

async function detectBoards(): Promise<void> {
    try {
        outputChannel.appendLine('Detecting boards...');
        updateStatusBar('Detecting boards...');
        
        const boards = await serialManager.detectBoards();
        
        outputChannel.appendLine(`Detected ${boards.length} board(s):`);
        boards.forEach((board, index) => {
            outputChannel.appendLine(`  ${index + 1}. ${board.friendlyName} (${board.port})`);
        });
        
        if (boards.length === 0) {
            vscode.window.showInformationMessage('No MSPM0 boards detected. Please check connections and drivers.');
            updateStatusBar('No boards found');
        } else {
            vscode.window.showInformationMessage(`Found ${boards.length} MSPM0 board(s). Check output for details.`);
            updateStatusBar(`${boards.length} boards found`);
        }
        
    } catch (error) {
        const errorMessage = error instanceof Error ? error.message : String(error);
        outputChannel.appendLine(`Board detection failed: ${errorMessage}`);
        updateStatusBar('Detection failed');
        vscode.window.showErrorMessage(`Board detection failed: ${errorMessage}`);
    }
}

function openExtensionSettings(): void {
    outputChannel.appendLine('Opening Port11 Debugger settings...');
    vscode.commands.executeCommand('workbench.action.openSettings', 'port11-debugger');
}

function updateStatusBar(text: string): void {
    if (statusBarItem) {
        statusBarItem.text = `$(chip) Port11: ${text}`;
        statusBarItem.tooltip = 'Port11 Debugger - Click to show panel';
        statusBarItem.show();
    }
}

// Initialization functions

async function initializeExtension(): Promise<void> {
    outputChannel.appendLine('Starting extension initialization...');
    
    // Check if status bar should be enabled
    const enableStatusBar = vscode.workspace.getConfiguration('port11-debugger').get('enableStatusBar', true);
    if (enableStatusBar) {
        updateStatusBar('Initializing...');
    }

    // Check for first-time setup
    await checkFirstTimeSetup();
    
    // Auto-detect boards if enabled
    const autoDetectBoards = vscode.workspace.getConfiguration('port11-debugger').get('autoDetectBoards', true);
    if (autoDetectBoards) {
        try {
            await detectBoards();
        } catch (error) {
            outputChannel.appendLine(`Auto board detection failed: ${error}`);
        }
    }
    
    // Check for updates if enabled
    const checkForUpdates = vscode.workspace.getConfiguration('port11-debugger').get('checkForUpdatesOnStartup', true);
    if (checkForUpdates) {
        checkForExtensionUpdates();
    }

    // Initial status refresh
    await refreshStatus();
    
    outputChannel.appendLine('Extension initialization completed');
}

async function checkFirstTimeSetup(): Promise<void> {
    try {
        // Check if toolchain is already installed
        const sdkInstalled = await sdkManager.isSDKInstalled();
        const toolchainInstalled = await toolchainManager.isToolchainInstalled();
        
        if (!sdkInstalled || !toolchainInstalled) {
            outputChannel.appendLine('First-time setup detected');
            
            const showWelcome = vscode.workspace.getConfiguration('port11-debugger').get('showWelcomeOnStartup', true);
            
            if (showWelcome) {
                const result = await vscode.window.showInformationMessage(
                    'Port11 Debugger: Setup required for MSPM0 development. Would you like to set up the toolchain now?',
                    { title: 'Setup Now', isCloseAffordance: false },
                    { title: 'Setup Later', isCloseAffordance: false },
                    { title: 'Don\'t Show Again', isCloseAffordance: true }
                );
                
                if (result?.title === 'Setup Now') {
                    await setupToolchain();
                } else if (result?.title === 'Don\'t Show Again') {
                    await vscode.workspace.getConfiguration('port11-debugger').update(
                        'showWelcomeOnStartup', 
                        false, 
                        vscode.ConfigurationTarget.Global
                    );
                }
            }
        } else {
            outputChannel.appendLine('Toolchain already installed, skipping first-time setup');
        }
    } catch (error) {
        const errorMessage = error instanceof Error ? error.message : String(error);
        outputChannel.appendLine(`First-time setup check failed: ${errorMessage}`);
    }
}

function checkForExtensionUpdates(): void {
    // This is a placeholder for future update checking functionality
    outputChannel.appendLine('Checking for extension updates... (not implemented yet)');
    
    // Future implementation could:
    // 1. Check VS Code marketplace for newer versions
    // 2. Check GitHub releases for DAP binary updates
    // 3. Check TI website for newer toolchain versions
    // 4. Notify user of available updates
}

// Context and state management

export function getExtensionContext(): vscode.ExtensionContext | undefined {
    // This would need to be properly implemented to store and return context
    return undefined;
}

export function getManagers() {
    return {
        sdkManager,
        toolchainManager,
        serialManager,
        outputChannel,
        statusBarItem
    };
}

export function getWebviewProvider(): WebviewProvider {
    return webviewProvider;
}

// Error handling and logging utilities

export function logError(error: Error | string, context?: string): void {
    const errorMessage = error instanceof Error ? error.message : error;
    const logMessage = context ? `[${context}] ${errorMessage}` : errorMessage;
    
    outputChannel.appendLine(`ERROR: ${logMessage}`);
    
    if (error instanceof Error && error.stack) {
        outputChannel.appendLine(`Stack trace: ${error.stack}`);
    }
}

export function logWarning(message: string, context?: string): void {
    const logMessage = context ? `[${context}] ${message}` : message;
    outputChannel.appendLine(`WARNING: ${logMessage}`);
}

export function logInfo(message: string, context?: string): void {
    const logLevel = vscode.workspace.getConfiguration('port11-debugger').get('logLevel', 'info');
    
    if (['info', 'debug', 'trace'].includes(logLevel)) {
        const logMessage = context ? `[${context}] ${message}` : message;
        outputChannel.appendLine(`INFO: ${logMessage}`);
    }
}

export function logDebug(message: string, context?: string): void {
    const logLevel = vscode.workspace.getConfiguration('port11-debugger').get('logLevel', 'info');
    
    if (['debug', 'trace'].includes(logLevel)) {
        const logMessage = context ? `[${context}] ${message}` : message;
        outputChannel.appendLine(`DEBUG: ${logMessage}`);
    }
}